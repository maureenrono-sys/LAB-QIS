<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Indicators | Lab-QIS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="sidebar">
        <div class="text-center pb-4 border-bottom border-secondary">
            <h4 class="text-white fw-bold">LAB-QIS</h4>
        </div>
        <div class="mt-3">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="departments.html" class="nav-link">Departments</a>
            <a href="qc.html" class="nav-link">Quality Control</a>
            <a href="indicators.html" class="nav-link active">Quality Indicators</a>
            <a href="equipment.html" class="nav-link">Equipment Log</a>
            <a href="nc-capa.html" class="nav-link">NC & CAPA</a>
            <a href="documents.html" class="nav-link">Documents</a>
            <a href="audits.html" class="nav-link">SLIPTA Audits</a>
            <a href="analytics.html" class="nav-link">Risk & Analytics</a>
            <a href="benchmarking.html" class="nav-link">Peer Benchmarking</a>
            <a href="operations-center.html" class="nav-link">Operations Center</a>
            <a href="client-feedback.html" class="nav-link">Client Feedback</a>
            <a href="admin-portal.html" class="nav-link">Admin Portal</a>
        </div>
    </div>

    <div class="main-content-area">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h3 class="fw-bold text-navy mb-0">Laboratory Quality Indicators</h3>
            <button id="refreshIndicatorsBtn" class="btn btn-outline-primary btn-sm">Refresh Indicators</button>
        </div>

        <div class="card card-clinical p-3 mb-4">
            <h6 class="fw-bold mb-3">Add Indicator Record</h6>
            <form id="qiForm" class="row g-2">
                <div class="col-md-3">
                    <input type="text" id="qiName" class="form-control" placeholder="Indicator name" required>
                </div>
                <div class="col-md-2">
                    <select id="qiPhase" class="form-select">
                        <option value="Pre-analytical">Pre-analytical</option>
                        <option value="Analytical">Analytical</option>
                        <option value="Post-analytical">Post-analytical</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" id="qiTarget" class="form-control" placeholder="Target %" required>
                </div>
                <div class="col-md-2">
                    <input type="number" id="qiActual" class="form-control" placeholder="Actual %" required>
                </div>
                <div class="col-md-2">
                    <input type="text" id="qiIso" class="form-control" placeholder="ISO clause (opt)">
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
            <div id="qiStatus" class="small text-muted mt-2"></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card card-clinical p-4 shadow-sm">
                    <h5 class="fw-bold"><i class="bi bi-bar-chart"></i> Actual Performance</h5>
                    <p class="small text-muted mb-3">Latest values from <code>GET /api/qi</code></p>
                    <canvas id="actualChart"></canvas>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-clinical p-4 shadow-sm">
                    <h5 class="fw-bold"><i class="bi bi-bullseye"></i> Target vs Actual</h5>
                    <p class="small text-muted mb-3">Target threshold from each indicator record</p>
                    <canvas id="targetChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card card-clinical p-3">
            <h6 class="fw-bold mb-3">Recent Indicator Records</h6>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Indicator</th>
                            <th>Phase</th>
                            <th>Target</th>
                            <th>Actual</th>
                            <th>Status</th>
                            <th>Month</th>
                        </tr>
                    </thead>
                    <tbody id="qiTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/api';
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = 'index.html';
        }

        const qiStatus = document.getElementById('qiStatus');
        let actualChart;
        let targetChart;

        function monthLabel() {
            return new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function renderTable(records) {
            const tableBody = document.getElementById('qiTableBody');
            tableBody.innerHTML = records.map(qi => `
                <tr>
                    <td>${qi.name}</td>
                    <td>${qi.phase}</td>
                    <td>${qi.targetPercentage}%</td>
                    <td>${qi.actualPercentage}%</td>
                    <td>
                        <span class="badge ${Number(qi.actualPercentage) >= Number(qi.targetPercentage) ? 'bg-success' : 'bg-danger'}">
                            ${Number(qi.actualPercentage) >= Number(qi.targetPercentage) ? 'Met' : 'Not Met'}
                        </span>
                    </td>
                    <td>${qi.month || '-'}</td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="text-center text-muted">No indicator records found.</td></tr>';
        }

        function renderCharts(records) {
            const labels = records.slice(0, 10).map(item => item.name);
            const actual = records.slice(0, 10).map(item => Number(item.actualPercentage));
            const target = records.slice(0, 10).map(item => Number(item.targetPercentage));

            if (actualChart) actualChart.destroy();
            if (targetChart) targetChart.destroy();

            actualChart = new Chart(document.getElementById('actualChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Actual %',
                        data: actual,
                        backgroundColor: '#3498db'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            targetChart = new Chart(document.getElementById('targetChart'), {
                data: {
                    labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Actual %',
                            data: actual,
                            backgroundColor: 'rgba(26, 188, 156, 0.65)'
                        },
                        {
                            type: 'line',
                            label: 'Target %',
                            data: target,
                            borderColor: '#e67e22',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        async function loadIndicators() {
            qiStatus.textContent = 'Loading indicators...';
            const res = await fetch(`${API_URL}/qi`, {
                headers: { Authorization: `Bearer ${token}` }
            });

            if (!res.ok) {
                qiStatus.textContent = 'Could not load indicators from API.';
                return;
            }

            const records = await res.json();
            renderTable(records);
            renderCharts(records);
            qiStatus.textContent = `${records.length} indicator record(s) loaded.`;
        }

        async function addIndicator(e) {
            e.preventDefault();
            qiStatus.textContent = 'Saving indicator...';

            const payload = {
                name: document.getElementById('qiName').value.trim(),
                phase: document.getElementById('qiPhase').value,
                targetPercentage: Number(document.getElementById('qiTarget').value),
                actualPercentage: Number(document.getElementById('qiActual').value),
                month: monthLabel(),
                isoClause: document.getElementById('qiIso').value.trim() || null
            };

            const res = await fetch(`${API_URL}/qi`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({ message: 'Failed to save indicator.' }));
                qiStatus.textContent = err.message || 'Failed to save indicator.';
                return;
            }

            document.getElementById('qiForm').reset();
            qiStatus.textContent = 'Indicator saved.';
            await loadIndicators();
        }

        document.getElementById('qiForm').addEventListener('submit', addIndicator);
        document.getElementById('refreshIndicatorsBtn').addEventListener('click', loadIndicators);
        loadIndicators();
    </script>
</body>
</html>






