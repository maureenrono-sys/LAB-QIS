<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth | Lab-QIS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .auth-shell {
            min-height: 100vh;
            background:
                radial-gradient(circle at 10% 10%, rgba(123, 44, 191, 0.25), transparent 45%),
                radial-gradient(circle at 90% 90%, rgba(20, 184, 166, 0.18), transparent 40%),
                #f6f4ff;
        }

        .auth-card {
            width: 100%;
            max-width: 560px;
            border: 0;
            border-radius: 18px;
            box-shadow: 0 16px 36px rgba(64, 31, 110, 0.18);
        }

        .auth-toggle .btn {
            border-radius: 999px;
            min-width: 140px;
        }

        .form-note {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .auth-card h2 {
            letter-spacing: 0.02em;
        }

        .auth-card .form-label {
            font-weight: 600;
            color: #4b5563;
        }

        .auth-card .form-control,
        .auth-card .form-select {
            border-radius: 10px;
            border: 1px solid #dfd4ff;
            background: #fbfaff;
        }

        .auth-card .form-control:focus,
        .auth-card .form-select:focus {
            border-color: #5d3fd3;
            box-shadow: 0 0 0 0.2rem rgba(93, 63, 211, 0.18);
            background: #ffffff;
        }

        #demoAdminBtn {
            border-radius: 10px;
            border-color: #b9a8f1;
            color: #5d3fd3;
            font-weight: 600;
        }

        #demoAdminBtn:hover,
        #demoAdminBtn:focus {
            background: #5d3fd3;
            border-color: #5d3fd3;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <main class="auth-shell d-flex align-items-center justify-content-center p-3">
        <section class="card auth-card card-clinical p-4 p-md-5">
            <div class="text-center mb-4">
                <h2 class="text-navy fw-bold mb-1">LAB-QIS</h2>
                <p class="text-muted mb-0">Quality Intelligence System</p>
            </div>

            <div class="auth-toggle d-flex justify-content-center gap-2 mb-4">
                <button id="showLoginBtn" type="button" class="btn btn-primary btn-sm">Sign In</button>
                <button id="showSignupBtn" type="button" class="btn btn-outline-primary btn-sm">Sign Up</button>
            </div>

            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 bg-med-blue">Access Laboratory</button>
                <button id="demoAdminBtn" type="button" class="btn btn-outline-primary w-100 mt-2">Setup Demo + Login as Admin</button>
            </form>

            <form id="signupForm" class="d-none">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="signupName" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Role</label>
                        <select id="signupRole" class="form-select" required>
                            <option value="ADMIN">Admin</option>
                            <option value="LAB_MANAGER">Lab Manager</option>
                            <option value="QUALITY_ASSURANCE_MANAGER">Quality Manager</option>
                            <option value="LAB_TECHNOLOGIST">Lab Technologist</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Password</label>
                        <input type="password" id="signupPassword" class="form-control" minlength="6" required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Laboratory Name</label>
                        <input type="text" id="signupLabName" class="form-control" placeholder="e.g. Central Diagnostic Laboratory" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Lab Type</label>
                        <select id="signupLabType" class="form-select">
                            <option value="Private">Private</option>
                            <option value="Public">Public</option>
                            <option value="Mid-level">Mid-level</option>
                        </select>
                    </div>
                </div>
                <p class="form-note mt-3 mb-2">Sign up creates your account and signs you in immediately.</p>
                <button type="submit" class="btn btn-primary w-100">Create Account</button>
            </form>

            <div id="message" class="mt-3 text-center text-danger small"></div>
        </section>
    </main>

    <script>
        const API_CANDIDATES = [
            'http://localhost:5000/api',
            'http://127.0.0.1:5000/api'
        ];
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const messageEl = document.getElementById('message');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showSignupBtn = document.getElementById('showSignupBtn');

        async function fetchWithApiFallback(path, options) {
            let lastError = null;
            for (const apiBase of API_CANDIDATES) {
                try {
                    return await fetch(`${apiBase}${path}`, options);
                } catch (error) {
                    lastError = error;
                }
            }
            throw lastError || new Error('Failed to reach API.');
        }

        function persistSession(data, options = {}) {
            const { isDemo = false } = options;
            localStorage.setItem('token', data.token);
            localStorage.setItem('userRole', data.user.role);
            localStorage.setItem('roleKey', data.user.roleKey || '');
            localStorage.setItem('labName', data.user.labName || '');
            localStorage.setItem('fullName', data.user.fullName || '');
            localStorage.setItem('profilePhotoUrl', data.user.profilePhotoUrl || '');
            localStorage.setItem('lastLoginAt', data.user.lastLoginAt || '');
            localStorage.setItem('isDemoMode', isDemo ? 'true' : 'false');
            localStorage.removeItem('viewRoleKey');
        }

        async function loginWithCredentials(email, password, options = {}) {
            const response = await fetchWithApiFallback('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Login failed.');
            }
            persistSession(data, options);
            window.location.href = 'dashboard.html';
        }

        function setAuthView(showSignup) {
            signupForm.classList.toggle('d-none', !showSignup);
            loginForm.classList.toggle('d-none', showSignup);
            showSignupBtn.classList.toggle('btn-primary', showSignup);
            showSignupBtn.classList.toggle('btn-outline-primary', !showSignup);
            showLoginBtn.classList.toggle('btn-primary', !showSignup);
            showLoginBtn.classList.toggle('btn-outline-primary', showSignup);
            messageEl.textContent = '';
        }

        showLoginBtn.addEventListener('click', () => setAuthView(false));
        showSignupBtn.addEventListener('click', () => setAuthView(true));

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await loginWithCredentials(
                    document.getElementById('loginEmail').value.trim(),
                    document.getElementById('loginPassword').value
                );
            } catch (err) {
                messageEl.textContent = err.message || 'Unable to reach server. Confirm backend is running on port 5000.';
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const payload = {
                    fullName: document.getElementById('signupName').value.trim(),
                    email: document.getElementById('signupEmail').value.trim(),
                    password: document.getElementById('signupPassword').value,
                    roleKey: document.getElementById('signupRole').value,
                    labName: document.getElementById('signupLabName').value.trim(),
                    labType: document.getElementById('signupLabType').value
                };

                const response = await fetchWithApiFallback('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'Signup failed.');
                }

                persistSession(data, { isDemo: false });
                window.location.href = 'dashboard.html';
            } catch (err) {
                messageEl.textContent = err.message || 'Unable to create account.';
            }
        });

        document.getElementById('demoAdminBtn').addEventListener('click', async () => {
            try {
                messageEl.textContent = 'Preparing demo data...';
                const seedResponse = await fetchWithApiFallback('/auth/demo-bootstrap', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const seedData = await seedResponse.json();
                if (!seedResponse.ok) {
                    throw new Error(seedData.message || 'Demo setup failed.');
                }
                await loginWithCredentials('admin@labqis.demo', 'Admin@123', { isDemo: true });
            } catch (error) {
                messageEl.textContent = error.message || 'Unable to create demo data.';
            }
        });
    </script>
</body>
</html>
